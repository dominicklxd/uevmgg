<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Asistencia - Unidad Educativa Víctor Manuel Guzmán</title>
    <link rel="stylesheet" href="css.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        .asistencia-section {
            max-width: 1200px;
            margin: 3rem auto 2rem auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(44,130,201,0.10);
            padding: 2.5rem 2rem;
        }
        .asistencia-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            justify-content: center;
        }
        .curso-card {
            background: #f8fafd;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(44,130,201,0.10);
            padding: 1.5rem 1rem;
            min-width: 260px;
            max-width: 320px;
            flex: 1 1 300px;
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            min-height: 60px;
            max-height: 60px;
            overflow: hidden;
            justify-content: center;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .curso-card:hover {
            background: #eaf2fb;
            box-shadow: 0 4px 16px rgba(44,130,201,0.13);
        }
        .curso-card h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #2f5597;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
        }
        .asistencia-list {
            width: 100%;
            margin-top: 1em;
        }
        .asistencia-list table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.98rem;
        }
        .asistencia-list th, .asistencia-list td {
            padding: 0.4em 0.2em;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
        }
        .asistencia-list th {
            background: #eaf2fb;
            color: #2f5597;
        }
        .asistencia-list input[type="checkbox"] {
            transform: scale(1.2);
        }
        .asistencia-btn {
            margin-top: 1em;
            background: linear-gradient(90deg, #548235 60%, #2f5597 100%);
            color: #fff;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            padding: 0.5em 1.5em;
            cursor: pointer;
            transition: background 0.18s, transform 0.18s;
        }
        .asistencia-btn:hover {
            background: linear-gradient(90deg, #2f5597 60%, #548235 100%);
            transform: scale(1.04);
        }
        .asistencia-exito {
            color: #548235;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1rem;
        }
        #modal-asistencia {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(44,130,201,0.13);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        #modal-asistencia .modal-content {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(44,130,201,0.18);
            padding: 2.5rem 2rem;
            max-width: 1000px; /* Aumenta el ancho del modal */
            width: 98vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        #modal-asistencia .close-modal {
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 1.7rem;
            color: #2f5597;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        #modal-asistencia h3 {
            margin-top: 0;
            color: #2f5597;
            font-size: 1.2rem;
            text-align: center;
        }
        #modal-asistencia .fecha-group {
            margin-bottom: 1em;
            text-align: center;
        }
        #modal-asistencia table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.08rem;
        }
        #modal-asistencia table th, #modal-asistencia table td {
            padding: 0.4em 0.2em;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
            font-size: 1.08rem;
        }
        #modal-asistencia th {
            background: #eaf2fb;
            color: #2f5597;
        }
        #modal-asistencia input[type="checkbox"] {
            transform: scale(1.2);
        }
        #modal-asistencia .asistencia-btn {
            margin-top: 1em;
            background: linear-gradient(90deg, #548235 60%, #2f5597 100%);
            color: #fff;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            padding: 0.5em 1.5em;
            cursor: pointer;
            transition: background 0.18s, transform 0.18s;
            width: 100%;
        }
        #modal-asistencia .asistencia-btn:hover {
            background: linear-gradient(90deg, #2f5597 60%, #548235 100%);
            transform: scale(1.04);
        }
        #modal-asistencia .asistencia-exito {
            color: #548235;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1rem;
        }
        #modal-asistencia .horas-header {
            text-align: center;
            font-weight: bold;
            color: #2f5597;
            font-size: 1.08rem;
            background: #eaf2fb;
            border-bottom: 1px solid #e0e0e0;
            letter-spacing: 1px;
        }
        #modal-asistencia .hora-checkbox {
            width: 1.5em;
            height: 1.5em;
            accent-color: #2f5597;
        }
        #modal-asistencia select.hora-select {
            min-width: 70px;
            padding: 0.2em 0.4em;
            font-size: 1em;
            border-radius: 6px;
            border: 1px solid #b5c6e0;
            background: #f8fafd;
            color: #2f5597;
            margin: 0 2px;
        }
        #modal-asistencia .hora-select[disabled] {
            background: #f3f3f3;
            color: #888;
        }
        #modal-asistencia .leyenda-asistencia {
            margin: 0.7em 0 1em 0;
            font-size: 0.98em;
            color: #2f5597;
            text-align: center;
            background: #eaf2fb;
            border-radius: 8px;
            padding: 0.5em 0.7em;
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (max-width: 900px) {
            .asistencia-grid { flex-direction: column; align-items: center; }
            .curso-card { min-width: 90vw; max-width: 98vw; }
        }
    </style>
</head>
<body>
    <div class="top-bars">
        <div class="top-bar-1"></div>
        <div class="top-bar-2"></div>
    </div>
    <img src="referencia.png" alt="Imagen de referencia" style="display: block; margin: 0 auto; margin-top: 10px;">
    <header>
        <div class="header-top">
            <img src="unidad-educativa-logo.png" alt="Logo de la Institución" class="logo">
            <div class="header-text">
                <h1>Unidad Educativa </h1>
                <h1>"Víctor Manuel Guzmán"</h1>
                <p>Educando para la vida</p>
            </div>
            <div class="auth-links">
                <!-- Los enlaces se gestionarán dinámicamente desde script.js -->
            </div>
            <div id="saludo-usuario" style="position:absolute; right:30px; bottom:-30px; font-size:1.1rem; color:#2f5597; font-weight:bold; background:rgba(255,255,255,0.95); border-radius:8px; padding:0.3em 1em; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:none; z-index:10;">
                <!-- Aquí se mostrará el saludo -->
            </div>
            <nav>
                <ul class="menu">
                    <li><a href="index.html">Inicio</a></li>
                    <li class="dropdown">
                        <a href="#">Nosotros</a>
                        <ul class="submenu">
                            <li><a href="quienes-somos.html">Quiénes Somos</a></li>
                            <li><a href="autoridades.html">Autoridades</a></li>
                            <li><a href="ambientes.html">Sede y Ambientes</a></li>
                            <li><a href="simbolos.html">Símbolos Institucionales</a></li>
                            <li><a href="oferta-educativa.html">Oferta Educativa</a></li>
                            <li><a href="especialidades.html">Especialidades</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Docentes</a>
                        <ul class="submenu">
                            <li><a href="calendario.html">Cronograma de Actividades</a></li>
                            <li><a href="sistemas-ministerio-educacion.html">Sistemas del Ministerio de Educación</a></li>
                            <li><a href="https://recursos.educacion.gob.ec/" target="_blank" rel="noopener">Recursos Didácticos</a></li>
                            <li><a href="https://aulavirtual.uevmg.com/" target="_blank" rel="noopener">Aula Virtual Institucional</a></li>
                            <li><a href="asistencia.html">Control de Asistencia</a></li>
                            <li><a href="promocion-estudiantes.html">Promociones</a></li>
                            <li><a href="https://academico.educarecuador.gob.ec/" target="_blank" rel="noopener">Ingreso de Notas Académico</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Padres de Familia</a>
                        <ul class="submenu">
                            <li><a href="comite-padres.html">Comité Central de Padres de Familia</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Estudiantes</a>
                        <ul class="submenu">
                            <li><a href="consejo-estudiantil.html">Consejo Estudiantil</a></li>
                            <li><a href="cuadro-honor.html">Cuadro de Honor</a></li>
                            <li><a href="horario-clases.html">Horario de Clases</a></li>
                            <li><a href="uniforme-escolar.html">Uniforme Escolar</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Servicios</a>
                        <ul class="submenu">
                            <li><a href="dece.html">DECE</a></li>
                            <li><a href="bar-institucional.html">Bar Institucional</a></li>
                            <li><a href="banda-musical.html">Banda Musical</a></li>
                            <li><a href="biblioteca-virtual.html">Biblioteca Virtual</a></li>
                            <li><a href="bastoneras.html">Grupo de Bastoneras y Cachiporreros</a></li>
                        </ul>
                    </li>
                    <li><a href="contactos.html">Contactos</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <!-- Burbujas flotantes igual que index.html -->
    <div class="floating-bubbles" style="display:none;">
        <!-- Las burbujas se llenan dinámicamente por JS -->
    </div>
    <div id="admin-bubble-container"></div>
    <main style="margin-top: 120px;">
        <section class="asistencia-section">
            <h2 class="section-title" style="text-align:center;">Registro de Asistencia</h2>
            <div id="asistencia-exito" class="asistencia-exito" style="display:none;"></div>
            <div class="asistencia-grid" id="asistencia-grid">
                <!-- Aquí se generan los recuadros de cursos dinámicamente -->
            </div>
        </section>
        <!-- Modal flotante para asistencia -->
        <div id="modal-asistencia">
            <div class="modal-content">
                <button class="close-modal" id="cerrar-modal">&times;</button>
                <h3 id="modal-titulo"></h3>
                <div class="fecha-group">
                    <label for="modal-fecha">Fecha:</label>
                    <input type="date" id="modal-fecha">
                </div>
                <div class="leyenda-asistencia">
                    <b>Opciones de asistencia por hora:</b>
                    <span style="margin-left:10px;">AS: Asistido</span>
                    <span style="margin-left:10px;">A: Atraso</span>
                    <span style="margin-left:10px;">FJ: Falta Justificada</span>
                    <span style="margin-left:10px;">FI: Falta Injustificada</span>
                    <span style="margin-left:10px;">AI: Abandono Interno</span>
                    <span style="margin-left:10px;">AE: Abandono Externo</span>
                    <span style="margin-left:10px;">P: Permiso</span>
                </div>
                <div style="display:flex; justify-content:flex-end;">
                    <button type="button" id="btn-editar-horas" class="asistencia-btn" style="width:auto; margin-bottom:10px; background:#2f5597;">Editar</button>
                </div>
                <form id="modal-form-asistencia">
                    <table>
                        <thead>
                            <tr>
                                <th rowspan="2" style="vertical-align:middle;">Estudiante</th>
                                <th rowspan="2" style="vertical-align:middle;">
                                    <!-- El checkbox de "marcar todas" ya no aplica, se puede quitar o dejar vacío -->
                                </th>
                                <th colspan="8" class="horas-header">Horas</th>
                                <th rowspan="2" style="vertical-align:middle;">Veces Asistida</th>
                                <th rowspan="2" style="vertical-align:middle;">Atrasos</th>
                                <th rowspan="2" style="vertical-align:middle;">Faltas Justificadas</th>
                                <th rowspan="2" style="vertical-align:middle;">Faltas Injustificadas</th>
                                <th rowspan="2" style="vertical-align:middle;">Abandono Interno</th>
                                <th rowspan="2" style="vertical-align:middle;">Permisos</th>
                                <th rowspan="2" style="vertical-align:middle;">Abandono Externo</th>
                                <th rowspan="2" style="vertical-align:middle;">Total de veces asistida</th>
                            </tr>
                            <tr>
                                <th>1</th>
                                <th>2</th>
                                <th>3</th>
                                <th>4</th>
                                <th>5</th>
                                <th>6</th>
                                <th>7</th>
                                <th>8</th>
                            </tr>
                        </thead>
                        <tbody id="modal-lista-estudiantes">
                            <!-- Lista dinámica -->
                        </tbody>
                    </table>
                    <button type="submit" class="asistencia-btn">Registrar Asistencia</button>
                </form>
                <div class="asistencia-exito" id="modal-exito" style="display:none;"></div>
            </div>
        </div>
    </main>
    <!-- ...existing code... -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>UNIDAD EDUCATIVA "VICTOR MANUEL GUZMAN"</h3>
                <div class="footer-line"></div>
                <p>Todos los contenidos digitales del portal web, se prohíbe su reproducción total, parcial y traducción a cualquier idioma sin autorización escrita por su titular.</p>
            </div>
            <div class="footer-section">
                <h3>ACCESOS DIRECTOS</h3>
                <div class="footer-line"></div>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="registro.html">Registro</a></li>
                    <li><a href="#autoridades">Autoridades</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>CONTACTOS</h3>
                <div class="footer-line"></div>
                <p>(09) 096 305 3811</p>
                <p> uevmg2023@gmail.com</p>
                <p>De lunes a viernes: 07:00 - 17:00</p>
            </div>
            <div class="footer-section">
                <h3>UBICACIÓN</h3>
                <div class="footer-line"></div>
                <div style="margin-top:5px; text-align:center;">
                    <iframe 
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1994.874824133404!2d-78.11604869660802!3d0.33616444871436085!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x8e2a3cd3c813c32d%3A0xf395292710b25406!2sUnidad%20Educativa%20V%C3%ADctor%20Manuel%20Guzm%C3%A1n!5e0!3m2!1ses-419!2sec!4v1744093697198!5m2!1ses-419!2sec" 
                        width="180" height="110" style="border:0;border-radius:8px;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Unidad Educativa Victor Manuel Guzmán © Copyrights 2025 Realizado por Dominick López, Juan Alba y Hugo Castillo</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="script.js"></script>
    <script>
        const supabaseUrl = "https://zeijayrxciyzymysbyvp.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplaWpheXJ4Y2l5enlteXNieXZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNjYyMjMsImV4cCI6MjA1OTc0MjIyM30.DxT8_5acA88JxhVV7n2UqmrZ_9d0DPABi6eKSO8cpDE";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- Solo acceso a roles permitidos ---
        const usuarioActivo = localStorage.getItem('usuarioActivo');
        async function verificarAccesoAsistencia() {
            if (!usuarioActivo) {
                alert('Debe iniciar sesión.');
                window.location.href = 'login.html';
                return false;
            }
            // Buscar id_cedula
            const { data: cedulaObj } = await supabase
                .from('cedulas')
                .select('id_cedula')
                .eq('cedula', usuarioActivo)
                .maybeSingle();
            if (!cedulaObj) {
                alert('No tiene permisos.');
                window.location.href = 'index.html';
                return false;
            }
            // Buscar usuario por id_cedula
            const { data: usuario } = await supabase
                .from('usuarios')
                .select('rol')
                .eq('cedula', cedulaObj.id_cedula)
                .maybeSingle();
            if (!usuario || !usuario.rol) {
                alert('No tiene permisos.');
                window.location.href = 'index.html';
                return false;
            }
            const rol = usuario.rol.toLowerCase();
            if (!['profesor', 'rector', 'vicerrector', 'administrador', 'inspector'].includes(rol)) {
                alert('No tiene permisos para acceder a asistencia.');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // --- Cargar cursos y mostrar recuadros colapsados ---
        async function cargarCursosYEstudiantes() {
            const grid = document.getElementById('asistencia-grid');
            grid.innerHTML = '';

            // Traer todos los cursos_grado de Bachillerato y EGB
            const { data: cursosGrado, error: errorCursos } = await supabase
                .from('curso_grado')
                .select('id_grado, nombre_nivel, grado, paralelo, especialidad');
            if (errorCursos) {
                grid.innerHTML = '<div style="color:red;text-align:center;">Error al cargar cursos.</div>';
                return;
            }
            // Eliminar cursos duplicados por id_grado
            const cursosUnicos = [];
            const idsVistos = new Set();
            for (const curso of cursosGrado) {
                if (!idsVistos.has(curso.id_grado)) {
                    cursosUnicos.push(curso);
                    idsVistos.add(curso.id_grado);
                }
            }
            // --- Mostrar EGB (1ro a 10mo, paralelos A, B, C) ---
            // El campo grado es tipo string: "1ro", "2do", ..., "10mo"
            const egbs = cursosUnicos.filter(cg =>
                (cg.nombre_nivel || '').trim().toUpperCase() === "EGB" &&
                ["1ro","2do","3ro","4to","5to","6to","7mo","8vo","9no","10mo"].includes((cg.grado || '').trim().toLowerCase()) &&
                ["A", "B", "C"].includes((cg.paralelo + "").toUpperCase())
            );
            // Ordenar por grado y paralelo
            const gradoOrden = { "1ro":1, "2do":2, "3ro":3, "4to":4, "5to":5, "6to":6, "7mo":7, "8vo":8, "9no":9, "10mo":10 };
            egbs.sort((a, b) => (gradoOrden[(a.grado||"").toLowerCase()]||0) - (gradoOrden[(b.grado||"").toLowerCase()]||0) || a.paralelo.localeCompare(b.paralelo));
            for (const curso of egbs) {
                grid.innerHTML += `
                    <div class="curso-card" data-id-grado="${curso.id_grado}" data-titulo="${curso.grado}° EGB '${curso.paralelo}'">
                        <h3>${curso.grado}° EGB "${curso.paralelo}"</h3>
                    </div>
                `;
            }
            // --- Mostrar Bachillerato ---
            const cursosBach = cursosUnicos.filter(cg => (cg.nombre_nivel || "").trim().toUpperCase() === "BACHILLERATO");
            for (const curso of cursosBach) {
                grid.innerHTML += `
                    <div class="curso-card" data-id-grado="${curso.id_grado}" data-titulo="${curso.grado} Bachillerato ${curso.especialidad || ""} '${curso.paralelo}'">
                        <h3>${curso.grado} Bachillerato ${curso.especialidad || ""} "${curso.paralelo}"</h3>
                    </div>
                `;
            }
            // Asignar evento click a cada recuadro
            document.querySelectorAll('.curso-card').forEach(card => {
                card.addEventListener('click', () => abrirModalAsistencia(card.dataset.idGrado, card.dataset.titulo));
            });
        }

        // --- Modal flotante ---
        let editable = false;
        let estudiantesGlobal = [];
        let idsEstudiantesGlobal = [];
        let fechaActualGlobal = null;

        // Opciones para el menú de selección de asistencia por hora
        const opcionesAsistencia = [
            { valor: "AS", texto: "(AS)" },
            { valor: "A", texto: "(A)" },
            { valor: "FJ", texto: "(FJ)" },
            { valor: "FI", texto: "(FI)" },
            { valor: "AI", texto: "(AI)" },
            { valor: "AE", texto: "(AE)" },
            { valor: "P", texto: "(P)" }
        ];

        async function abrirModalAsistencia(idGrado, titulo) {
            // 1. Buscar inscripciones de ese grado
            const { data: inscripciones, error: errorIns } = await supabase
                .from('solicitud_inscripcion')
                .select('id')
                .eq('id_grado', idGrado);

            if (errorIns) {
                alert("Error al consultar inscripciones: " + errorIns.message);
                return;
            }
            const idsInscripcion = (inscripciones || []).map(i => i.id);

            // 2. Buscar estudiantes con esos id_inscripcion
            let estudiantes = [];
            if (idsInscripcion.length > 0) {
                const { data: ests, error: errorEst } = await supabase
                    .from('estudiante')
                    .select('id_estudiante, nombres, apellidos, id_inscripcion')
                    .in('id_inscripcion', idsInscripcion);

                if (errorEst) {
                    alert("Error al consultar estudiantes: " + errorEst.message);
                    return;
                }

                // 3. Filtrar solo los que tienen solicitud_matriculacion verificada
                const idsEstudiantes = ests.map(e => e.id_estudiante);
                let idsVerificados = [];
                if (idsEstudiantes.length > 0) {
                    const { data: matriculasVerificadas } = await supabase
                        .from('solicitud_matriculacion')
                        .select('id_estudiante')
                        .eq('estado', 'verificada')
                        .in('id_estudiante', idsEstudiantes);
                    idsVerificados = (matriculasVerificadas || []).map(x => x.id_estudiante);
                }
                estudiantes = (ests || []).filter(e => idsVerificados.includes(e.id_estudiante));
            }

            // --- ORDENAR ALFABÉTICAMENTE POR APELLIDOS Y NOMBRES ---
            estudiantes.sort((a, b) => {
                const apA = (a.apellidos || '').toLowerCase();
                const apB = (b.apellidos || '').toLowerCase();
                if (apA < apB) return -1;
                if (apA > apB) return 1;
                const nomA = (a.nombres || '').toLowerCase();
                const nomB = (b.nombres || '').toLowerCase();
                if (nomA < nomB) return -1;
                if (nomA > nomB) return 1;
                return 0;
            });

            estudiantesGlobal = estudiantes;
            idsEstudiantesGlobal = estudiantes.map(e => e.id_estudiante);

            // Función para renderizar la tabla según la fecha seleccionada
            async function renderTablaAsistencia(fechaSeleccionada, editableLocal = false) {
                fechaActualGlobal = fechaSeleccionada;
                // Consultar asistencias por estudiante en la fecha seleccionada
                let asistenciasFecha = [];
                let asistenciasTotales = [];
                if (idsEstudiantesGlobal.length > 0) {
                    const { data: asisFecha } = await supabase
                        .from('asistencias')
                        .select('id_estudiante, presente, fecha, horas')
                        .in('id_estudiante', idsEstudiantesGlobal)
                        .eq('fecha', fechaSeleccionada);
                    asistenciasFecha = asisFecha || [];

                    const { data: asisTot } = await supabase
                        .from('asistencias')
                        .select('id_estudiante, horas')
                        .in('id_estudiante', idsEstudiantesGlobal);
                    asistenciasTotales = asisTot || [];
                }

                // Contar asistencias por estudiante
                const vecesAsistidaPorFecha = {};
                const totalVecesAsistida = {};
                // Función para determinar si cuenta como "asistido"
                function esAsistidoTodasLasHoras(horasObj) {
                    if (!horasObj) return false;
                    const permitidos = ["AS", "A", "FJ", "P"];
                    for (let h = 1; h <= 8; h++) {
                        const val = horasObj[h];
                        if (!val) return false;
                        if (["FI", "AI", "AE"].includes(val)) return false;
                    }
                    for (let h = 1; h <= 8; h++) {
                        if (!permitidos.includes(horasObj[h])) return false;
                    }
                    return true;
                }
                idsEstudiantesGlobal.forEach(id => {
                    const reg = asistenciasFecha.find(a => a.id_estudiante === id);
                    vecesAsistidaPorFecha[id] = reg && esAsistidoTodasLasHoras(reg.horas) ? 1 : 0;
                    totalVecesAsistida[id] = asistenciasTotales
                        .filter(a => a.id_estudiante === id)
                        .filter(a => esAsistidoTodasLasHoras(a.horas))
                        .length;
                });

                // Calcular totales por tipo para cada estudiante (de todas las fechas)
                function contarPorTipoTotal(asistenciasTotales, id_estudiante, tipo) {
                    let count = 0;
                    asistenciasTotales
                        .filter(a => a.id_estudiante === id_estudiante)
                        .forEach(a => {
                            const horas = a.horas || {};
                            for (let h = 1; h <= 8; h++) {
                                if (horas[h] === tipo) count++;
                            }
                        });
                    return count;
                }

                // Renderizar la tabla
                const tbody = document.getElementById('modal-lista-estudiantes');
                tbody.innerHTML = estudiantesGlobal.length > 0
                    ? estudiantesGlobal.map(est => {
                        const reg = asistenciasFecha.find(a => a.id_estudiante === est.id_estudiante);
                        const horasMarcadas = reg && reg.horas ? reg.horas : {};
                        // Totales de todas las fechas
                        const totalAtrasos = contarPorTipoTotal(asistenciasTotales, est.id_estudiante, "A");
                        const totalFJ = contarPorTipoTotal(asistenciasTotales, est.id_estudiante, "FJ");
                        const totalFI = contarPorTipoTotal(asistenciasTotales, est.id_estudiante, "FI");
                        const totalAI = contarPorTipoTotal(asistenciasTotales, est.id_estudiante, "AI");
                        const totalP = contarPorTipoTotal(asistenciasTotales, est.id_estudiante, "P");
                        const totalAE = contarPorTipoTotal(asistenciasTotales, est.id_estudiante, "AE");
                        return `
                            <tr>
                                <td>${est.apellidos || ""} ${est.nombres}</td>
                                <td></td>
                                ${[1,2,3,4,5,6,7,8].map(h => {
                                    const valor = horasMarcadas[h] || "AS";
                                    return `<td style="text-align:center;">
                                        <select class="hora-select" data-id="${est.id_estudiante}" data-hora="${h}" ${editableLocal ? "" : "disabled"}>
                                            ${opcionesAsistencia.map(opt =>
                                                `<option value="${opt.valor}" ${valor === opt.valor ? "selected" : ""}>${opt.texto}</option>`
                                            ).join("")}
                                        </select>
                                    </td>`;
                                }).join('')}
                                <td style="text-align:center;">${vecesAsistidaPorFecha[est.id_estudiante] || 0}</td>
                                <td style="text-align:center;">${totalAtrasos}</td>
                                <td style="text-align:center;">${totalFJ}</td>
                                <td style="text-align:center;">${totalFI}</td>
                                <td style="text-align:center;">${totalAI}</td>
                                <td style="text-align:center;">${totalP}</td>
                                <td style="text-align:center;">${totalAE}</td>
                                <td style="text-align:center;">${totalVecesAsistida[est.id_estudiante] || 0}</td>
                            </tr>
                        `;
                    }).join('')
                    : `<tr><td colspan="18" style="text-align:center;color:#888;">No hay estudiantes inscritos en este curso.</td></tr>`;

                // El checkbox de "marcar todas" ya no aplica, así que lo deshabilitamos
                const marcarTodas = document.getElementById('marcar-todas-horas');
                if (marcarTodas) {
                    marcarTodas.checked = false;
                    marcarTodas.disabled = true;
                    marcarTodas.onchange = null;
                }
            }

            // Mostrar modal y renderizar tabla with la fecha actual
            document.getElementById('modal-titulo').textContent = titulo;
            const inputFecha = document.getElementById('modal-fecha');
            inputFecha.value = new Date().toISOString().slice(0, 10);
            await renderTablaAsistencia(inputFecha.value, editable);
            document.getElementById('modal-asistencia').style.display = 'flex';
            document.getElementById('modal-exito').style.display = 'none';

            // Botón editar/guardar cambios
            const btnEditar = document.getElementById('btn-editar-horas');
            btnEditar.textContent = 'Editar';
            btnEditar.onclick = async function() {
                if (!editable) {
                    editable = true;
                    btnEditar.textContent = 'Guardar cambios';
                    await renderTablaAsistencia(inputFecha.value, editable);
                } else {
                    // Guardar cambios
                    const form = document.getElementById('modal-form-asistencia');
                    const registros = estudiantesGlobal.map(est => {
                        const horas = {};
                        for (let h = 1; h <= 8; h++) {
                            const sel = form.querySelector(`select.hora-select[data-id="${est.id_estudiante}"][data-hora="${h}"]`);
                            horas[h] = sel ? sel.value : "AS";
                        }
                        // presente: al menos una hora no es FI, AI, AE
                        const presente = Object.values(horas).some(v => !["FI", "AI", "AE"].includes(v));
                        return {
                            id_estudiante: est.id_estudiante,
                            fecha: inputFecha.value,
                            presente,
                            horas
                        };
                    });
                    const { error } = await supabase.from('asistencias').upsert(registros, { onConflict: ['id_estudiante', 'fecha'] });
                    const exito = document.getElementById('modal-exito');
                    if (!error) {
                        exito.textContent = '¡Cambios guardados!';
                        exito.style.display = 'block';
                        setTimeout(() => { exito.style.display = 'none'; }, 2000);
                        editable = false;
                        btnEditar.textContent = 'Editar';
                        setTimeout(async () => {
                            await renderTablaAsistencia(inputFecha.value, editable);
                        }, 200);
                    } else {
                        exito.textContent = 'Error al guardar cambios.';
                        exito.style.display = 'block';
                    }
                }
            };

            // Al cambiar la fecha, recargar la tabla y recoger datos actualizados de Supabase
            inputFecha.onchange = async function() {
                editable = false;
                btnEditar.textContent = 'Editar';
                await renderTablaAsistencia(inputFecha.value, editable);
            };

            // Evento submit (Registrar Asistencia)
            const form = document.getElementById('modal-form-asistencia');
            form.onsubmit = async function(e) {
                e.preventDefault();
                const registros = estudiantesGlobal.map(est => {
                    const horas = {};
                    for (let h = 1; h <= 8; h++) {
                        const sel = form.querySelector(`select.hora-select[data-id="${est.id_estudiante}"][data-hora="${h}"]`);
                        horas[h] = sel ? sel.value : "AS";
                    }
                    const presente = Object.values(horas).some(v => !["FI", "AI", "AE"].includes(v));
                    return {
                        id_estudiante: est.id_estudiante,
                        fecha: inputFecha.value,
                        presente,
                        horas
                    };
                });
                const { error } = await supabase.from('asistencias').upsert(registros, { onConflict: ['id_estudiante', 'fecha'] });
                const exito = document.getElementById('modal-exito');
                if (!error) {
                    exito.textContent = '¡Asistencia registrada!';
                    exito.style.display = 'block';
                    setTimeout(() => { exito.style.display = 'none'; }, 2000);
                    editable = false;
                    btnEditar.textContent = 'Editar';
                    setTimeout(async () => {
                        await renderTablaAsistencia(inputFecha.value, editable);
                    }, 200);
                } else {
                    exito.textContent = 'Error al registrar asistencia.';
                    exito.style.display = 'block';
                }
            };
        }

        // Cerrar modal
        document.getElementById('cerrar-modal').onclick = function() {
            document.getElementById('modal-asistencia').style.display = 'none';
        };

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', async function() {
            if (await verificarAccesoAsistencia()) {
                cargarCursosYEstudiantes();
            }
        });

        // Burbujas flotantes igual que index.html
        function renderFloatingBubbles() {
            const bubbles = document.querySelector('.floating-bubbles');
            if (!bubbles) return;
            bubbles.innerHTML = '';
            const usuarioActivo = localStorage.getItem('usuarioActivo');
            if (usuarioActivo) {
                bubbles.innerHTML = `
                    <a href="matricularse.html" class="floating-bubble" title="Matricularse">
                        <img src="icon-matricularse.png" alt="Matricularse">
                        <span class="floating-bubble-label">Matricularse</span>
                    </a>
                    <a href="perfil.html" class="floating-bubble" title="Perfil">
                        <img src="icon-perfil.png" alt="Perfil">
                        <span class="floating-bubble-label">Perfil</span>
                    </a>
                    <a href="#" class="floating-bubble" id="cerrar-sesion-bubble" title="Cerrar sesión">
                        <img src="icon-cerrar.png" alt="Cerrar sesión">
                        <span class="floating-bubble-label">Cerrar sesión</span>
                    </a>
                `;
                setTimeout(() => {
                    const cerrar = document.getElementById('cerrar-sesion-bubble');
                    if (cerrar) {
                        cerrar.onclick = function(e) {
                            e.preventDefault();
                            localStorage.removeItem('usuarioActivo');
                            window.location.href = "login.html";
                        };
                    }
                }, 50);
            } else {
                bubbles.innerHTML = `
                    <a href="registro.html" class="floating-bubble" title="Registrarse">
                        <img src="icon-registrarse.png" alt="Registrarse">
                        <span class="floating-bubble-label">Registrarse</span>
                    </a>
                    <a href="login.html" class="floating-bubble" title="Iniciar sesión">
                        <img src="icon-iniciar.png" alt="Iniciar sesión">
                        <span class="floating-bubble-label">Iniciar sesión</span>
                    </a>
                `;
            }
        }
        const header = document.querySelector('header');
        const bubbles = document.querySelector('.floating-bubbles');
        function toggleBubbles() {
            if (window.scrollY > 30) {
                header.classList.add('scrolled');
                if (bubbles) bubbles.style.display = 'flex';
            } else {
                header.classList.remove('scrolled');
                if (bubbles) bubbles.style.display = 'none';
            }
        }
        window.addEventListener('scroll', toggleBubbles);
        window.addEventListener('storage', function(e) {
            if (e.key === 'usuarioActivo') {
                renderFloatingBubbles();
            }
        });
        renderFloatingBubbles();
        toggleBubbles();
    </script>
</body>
</html>
