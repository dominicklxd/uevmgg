<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Crear Noticia - Unidad Educativa Víctor Manuel Guzmán</title>
    <link rel="stylesheet" href="css.css">
    <style>
        .crear-noticia-section {
            max-width: 600px;
            margin: 3rem auto 2rem auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(44,130,201,0.10);
            padding: 2.5rem 2rem;
        }
        .crear-noticia-section h2 {
            color: #2f5597;
            font-size: 2rem;
            margin-bottom: 1.2rem;
            text-align: center;
        }
        .crear-noticia-section label {
            font-weight: bold;
            color: #2f5597;
            margin-top: 1rem;
        }
        .crear-noticia-section input, .crear-noticia-section textarea {
            width: 100%;
            padding: 0.7rem;
            margin-bottom: 1.2rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .crear-noticia-section button {
            background: linear-gradient(90deg, #548235 60%, #2f5597 100%);
            color: #fff;
            font-weight: bold;
            padding: 0.7em 2em;
            border-radius: 8px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }
        .crear-noticia-section button:hover {
            background: linear-gradient(90deg, #2f5597 60%, #548235 100%);
            transform: scale(1.05);
        }
        .noticia-exito {
            color: #548235;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="top-bars">
        <div class="top-bar-1"></div>
        <div class="top-bar-2"></div>
    </div>
    <img src="referencia.png" alt="Imagen de referencia" style="display: block; margin: 0 auto; margin-top: 10px;">
    <header>
        <div class="header-top">
            <img src="unidad-educativa-logo.png" alt="Logo de la Institución" class="logo">
            <div class="header-text">
                <h1>Unidad Educativa </h1>
                <h1>"Víctor Manuel Guzmán"</h1>
                <p>50 años de Educación Estudiantil</p>
            </div>
            <div class="auth-links"></div>
            <div id="saludo-usuario" style="position:absolute; right:30px; bottom:-30px; font-size:1.1rem; color:#2f5597; font-weight:bold; background:rgba(255,255,255,0.95); border-radius:8px; padding:0.3em 1em; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:none; z-index:10;"></div>
            <nav>
                <ul class="menu">
                    <li><a href="index.html">Inicio</a></li>
                    <li class="dropdown">
                        <a href="#">Nosotros</a>
                        <ul class="submenu">
                            <li><a href="quienes-somos.html">Quiénes Somos</a></li>
                            <li><a href="autoridades.html">Autoridades</a></li>
                            <li><a href="historia.html">Historia</a></li>
                            <li><a href="ambientes.html">Sede y Ambientes</a></li>
                            <li><a href="simbolos.html">Símbolos Institucionales</a></li>
                            <li><a href="oferta-educativa.html">Oferta Educativa</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Docentes</a>
                        <ul class="submenu">
                            <li><a href="calendario.html">Cronograma de Actividades</a></li>
                            <li><a href="sistemas-ministerio-educacion.html">Sistemas del Ministerio de Educación</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Padres de Familia</a>
                        <ul class="submenu">
                            <li><a href="comite-padres.html">Comité Central de Padres de Familia</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Estudiantes</a>
                        <ul class="submenu">
                            <li><a href="consejo-estudiantil.html">Consejo Estudiantil</a></li>
                            <li><a href="cuadro-honor.html">Cuadro de Honor</a></li>
                            <li><a href="horario-clases.html">Horario de Clases</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Servicios</a>
                        <ul class="submenu">
                            <li><a href="dece.html">DECE</a></li>
                        </ul>
                    </li>
                    <li><a href="contactos.html">Contactos</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <section class="banner-section" style="margin-top: 100px;">
        <div class="banner-overlay">
            <h1>Crear Noticia</h1>
            <p><a href="index.html">Inicio</a> &gt; Noticias &gt; Crear Noticia</p>
        </div>
    </section>
    <main style="margin-top: 120px;">
        <section class="crear-noticia-section">
            <h2>Publicar Nueva Noticia</h2>
            <div id="noticia-exito" class="noticia-exito" style="display:none;"></div>
            <form id="form-noticia" enctype="multipart/form-data">
                <label for="titulo">Título de la noticia</label>
                <input type="text" id="titulo" name="titulo" maxlength="80" required>
                <label for="contenido">Contenido</label>
                <textarea id="contenido" name="contenido" rows="6" maxlength="600" required></textarea>
                <label for="autor">Autor</label>
                <input type="text" id="autor" name="autor" maxlength="40" placeholder="Ej: Prof. Juan Pérez" required>
                <label for="archivo">Adjuntar archivo (opcional)</label>
                <input type="file" id="archivo" name="archivo" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.mp4,.mp3,.zip,.rar,.txt,.csv">
                <button type="submit">Publicar Noticia</button>
            </form>
        </section>
    </main>
    <footer>
        <!-- ...igual que las demás páginas... -->
        <div class="footer-content">
            <div class="footer-section">
                <h3>UNIDAD EDUCATIVA "VICTOR MANUEL GUZMAN"</h3>
                <div class="footer-line"></div>
                <p>Todos los contenidos digitales del portal web, se prohíbe su reproducción total, parcial y traducción a cualquier idioma sin autorización escrita por su titular.</p>
            </div>
            <div class="footer-section">
                <h3>ACCESOS DIRECTOS</h3>
                <div class="footer-line"></div>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="registro.html">Registro</a></li>
                    <li><a href="#autoridades">Autoridades</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>CONTACTOS</h3>
                <div class="footer-line"></div>
                <p>(09) 096 305 3811</p>
                <p> uevmg2023@gmail.com</p>
                <p>De lunes a viernes: 07:00 - 17:00</p>
            </div>
            <div class="footer-section">
                <h3>UBICACIÓN</h3>
                <div class="footer-line"></div>
                <div style="margin-top:5px; text-align:center;">
                    <iframe 
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1994.874824133404!2d-78.11604869660802!3d0.33616444871436085!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x8e2a3cd3c813c32d%3A0xf395292710b25406!2sUnidad%20Educativa%20V%C3%ADctor%20Manuel%20Guzm%C3%A1n!5e0!3m2!1ses-419!2sec!4v1744093697198!5m2!1ses-419!2sec" 
                        width="180" height="110" style="border:0;border-radius:8px;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Unidad Educativa Victor Manuel Guzmán © Copyrights 2025 Realizado por Dominick López, Juan Alba y Hugo Castillo</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="script.js"></script>
    <script>
        // --- Configuración de Supabase ---
        const supabaseUrl = "https://zeijayrxciyzymysbyvp.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplaWpheXJ4Y2l5enlteXNieXZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNjYyMjMsImV4cCI6MjA1OTc0MjIyM30.DxT8_5acA88JxhVV7n2UqmrZ_9d0DPABi6eKSO8cpDE";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- Verificar rol desde la base de datos y obtener datos del usuario ---
        async function obtenerUsuarioActivo() {
            const cedulaStr = localStorage.getItem('usuarioActivo');
            console.log('Cédula en localStorage:', cedulaStr); // <-- Depuración
            if (!cedulaStr) return null;

            // Buscar el id_cedula correspondiente a la cédula string
            let { data: cedulaObj, error: cedulaError } = await supabase
                .from('cedulas')
                .select('id_cedula')
                .eq('cedula', cedulaStr)
                .maybeSingle();

            if (cedulaError || !cedulaObj) {
                alert('No se encontró la cédula en la tabla cedulas.');
                return null;
            }
            const idCedula = cedulaObj.id_cedula;
            console.log('id_cedula encontrado:', idCedula);

            // Buscar usuario por id_cedula (campo cedula en usuarios)
            let { data: usuario, error } = await supabase
                .from('usuarios')
                .select('rol, cedula, id_estudiante')
                .eq('cedula', idCedula)
                .maybeSingle();

            console.log('Usuario encontrado en Supabase:', usuario, 'Error:', error); // <-- Depuración
            if (!usuario) {
                alert('No se encontró el usuario en la base de datos. Verifica que la cédula esté correctamente registrada y que el usuario tenga rol e id_estudiante asignados.');
            } else if (!usuario.rol) {
                alert('El usuario no tiene rol asignado en la base de datos.');
            } else if (!usuario.id_estudiante) {
                alert('El usuario no tiene id_estudiante asignado en la base de datos.');
            }
            if (error || !usuario) return null;
            // Devuelve también el idCedula para usarlo al insertar la noticia
            return { ...usuario, idCedula };
        }

        async function verificarRolPermitidoNoticia() {
            const usuario = await obtenerUsuarioActivo();
            if (!usuario) {
                alert('Debes iniciar sesión para publicar noticias.');
                window.location.href = 'login.html';
                return false;
            }
            // Permitir solo a estos roles
            const rolesPermitidos = ['anunciador', 'rector', 'vicerrector', 'administrador'];
            if (!rolesPermitidos.includes(usuario.rol)) {
                alert('Solo los usuarios con rol "anunciador", "rector", "vicerrector" o "administrador" pueden publicar noticias.');
                window.location.href = 'index.html';
                return false;
            }
            if (!usuario.id_estudiante) {
                alert('Tu usuario no está vinculado a un estudiante. Contacta al administrador.');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // --- Bloquear acceso si no es permitido ---
        document.addEventListener('DOMContentLoaded', async function() {
            await verificarRolPermitidoNoticia();
        });

        // --- Publicar noticia ---
        document.getElementById('form-noticia').onsubmit = async function(e) {
            e.preventDefault();
            const puede = await verificarRolPermitidoNoticia();
            if (!puede) return;

            const usuario = await obtenerUsuarioActivo();
            if (!usuario) return;

            const titulo = document.getElementById('titulo').value.trim();
            const contenido = document.getElementById('contenido').value.trim();
            const autor = document.getElementById('autor').value.trim();
            const fecha = new Date().toISOString();
            const archivoInput = document.getElementById('archivo');
            let archivoUrl = "";
            let archivoNombre = "";

            if (archivoInput.files.length > 0) {
                const archivo = archivoInput.files[0];
                archivoNombre = Date.now() + "_" + archivo.name.replace(/\s+/g, "_");
                try {
                    let { error } = await supabase.storage.from('noticias').upload(archivoNombre, archivo, { upsert: true });
                    if (!error) {
                        const { data } = supabase.storage.from('noticias').getPublicUrl(archivoNombre);
                        archivoUrl = data && data.publicUrl ? data.publicUrl : "";
                    } else {
                        alert("Error al subir el archivo: " + error.message);
                        return;
                    }
                } catch (err) {
                    archivoUrl = "";
                    alert("Error inesperado al subir el archivo.");
                    return;
                }
            }

            // Mostrar los datos que se van a insertar
            const noticiaData = {
                titulo,
                contenido,
                autor,
                fecha,
                archivo_url: archivoUrl,
                archivo_nombre: archivoNombre,
                id_estudiante: usuario.id_estudiante,
                cedula: usuario.idCedula // <-- Agrega este campo
            };
            console.log('Datos a insertar en noticias:', noticiaData);

            // Insertar noticia en Supabase, asociando el id_estudiante y cedula del usuario
            const { error } = await supabase
                .from('noticias')
                .insert([noticiaData]);
            if (!error) {
                document.getElementById('noticia-exito').textContent = '¡Noticia publicada exitosamente!';
                document.getElementById('noticia-exito').style.display = 'block';
                document.getElementById('form-noticia').reset();
            } else {
                console.error('Error al insertar noticia:', error);
                alert('Error al publicar la noticia: ' + (error.message || JSON.stringify(error)));
            }
        };
    </script>
</body>
</html>
